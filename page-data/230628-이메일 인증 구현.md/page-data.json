{"componentChunkName":"component---src-templates-post-jsx","path":"/230628-이메일 인증 구현.md/","result":{"data":{"site":{"siteMetadata":{"title":"yujuck"}},"markdownRemark":{"id":"acde1ad6-6b72-5651-aefe-bd777f19cc39","excerpt":"구현하려는 이메일 인증 플로우 간단하게 동작으로만 플로우차트를 그려봤다. (자세한 API 내부 동작 플로우 생략)  1. JWT 발급 회원가입 이메일 인증에 를 사용했다.  정보만 두고 으로 설정했다.\n처음에는 유효시간을 30분으로 설정하고 만료된 토큰이 포함된 링크로 접속하면 인증 메일을 다시 전달받을 수 있도록 하려고 했는데,\n팀원들과 상의하여 유효시…","html":"<h2>구현하려는 이메일 인증 플로우</h2>\n<p>간단하게 동작으로만 플로우차트를 그려봤다. (자세한 API 내부 동작 플로우 생략)</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/49e408f04d9c74193d39f52d1f6d481d/ed632/join.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 79.41176470588235%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdtRFJ//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAARARUSH/2gAIAQEAAT8hpdKWFLDZ/9oADAMBAAIAAwAAABBX/wD/xAAYEQACAwAAAAAAAAAAAAAAAAAAAREhMf/aAAgBAwEBPxB3pCP/xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8QbX//xAAaEAACAwEBAAAAAAAAAAAAAAAAAREhMUHR/9oACAEBAAE/EHBUyoRcDtIk/SMEoP/Z'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='회원가입 버튼 클릭 이후 플로우' title='회원가입 버튼 클릭 이후 플로우' src='/static/49e408f04d9c74193d39f52d1f6d481d/a22ce/join.jpg' srcset='/static/49e408f04d9c74193d39f52d1f6d481d/0b705/join.jpg 170w,\n/static/49e408f04d9c74193d39f52d1f6d481d/31389/join.jpg 340w,\n/static/49e408f04d9c74193d39f52d1f6d481d/a22ce/join.jpg 680w,\n/static/49e408f04d9c74193d39f52d1f6d481d/ed632/join.jpg 917w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>회원가입 버튼 클릭 이후 플로우</figcaption>\n  </figure></p>\n<h2>1. JWT 발급</h2>\n<p>회원가입 이메일 인증에 <code class=\"language-text\">JWT</code>를 사용했다.<br>\n<code class=\"language-text\">payload에는 email</code> 정보만 두고 <code class=\"language-text\">expiresIn을 24시간</code>으로 설정했다.\n처음에는 유효시간을 30분으로 설정하고 만료된 토큰이 포함된 링크로 접속하면 인증 메일을 다시 전달받을 수 있도록 하려고 했는데,\n팀원들과 상의하여 유효시간은 24시간으로 두고 그 안에 인증하지 않으면 유저 정보를 삭제하는걸로 정했다.<br>\n이렇게 한 이유는 이메일 인증이 회원가입의 최종 단계로서 인증이 되지 않으면 로그인을 할 수 없는데, 실제로 사용하려는 유저라면 보통 바로 인증하기 때문에 24시간 내에 하지 않았다는건 사용하려는 의지가 없다라고 판단해서 삭제하기로 했다.<br>\n다른 곳들은 어떻게 하는지 궁금해..</p>\n<p>이렇게 발급받은 JWT는 API에서 만료시간 email 정보를 얻기 위해 사용된다.</p>\n<h2>2. 이메일 전송하기</h2>\n<p>회사에서는 <code class=\"language-text\">AWS SES</code>를 이용하고 있다. 회원가입 이메일 인증을 위한 템플릿은 미리 만들어두고 메일 내 <code class=\"language-text\">이메일 인증 버튼</code>에는 templateData를 전달받을 수 있도록 설정해두었다.</p>\n<p>백엔드에서 만든 이메일 전송 API는 프론트에서 전달해주는 이메일 템플릿 타입, email 주소, templateData를 전달받아 이메일 전송 command를 생성하여 호출하는 역할을 하도록 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">ISendEmailBody</span> <span class=\"token punctuation\">{</span>\n  template<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  email<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  templateData<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// JSON.stringify</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> emailRequestData <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  Source<span class=\"token operator\">:</span> <span class=\"token string\">\"보내는 사람 이메일\"</span><span class=\"token punctuation\">,</span>\n  Destination<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    ToAddresses<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>email<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  Template<span class=\"token operator\">:</span> template<span class=\"token punctuation\">,</span>\n  TemplateData<span class=\"token operator\">:</span> templateData <span class=\"token operator\">??</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">{}</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> command <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SendTemplatedEmailCommand</span><span class=\"token punctuation\">(</span>emailRequestData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sesClient<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>emailCommand<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>메일 내에 있는 이메일 인증 버튼에 백엔드 API의 endpoint를 설정하기 위해 templateData에는 템플릿에 설정한 변수(key)와 거기에 넣을 값을 객체 형태로 만든 후 string으로 전달해야한다.</p>\n<p>참고로 SendTemplatedEmailCommand 사용하면 templateData가 필수값인데, <code class=\"language-text\">''</code>, <code class=\"language-text\">'null'</code> 이런식으로 보내면 전송이 안되고 <code class=\"language-text\">{}</code> 이렇게 보내야 한다.</p>\n<br />\n<p>💡 Amazon Simple Email Service (SES)<br>\n사용자의 이메일 주소와 도메인을 사용해 이메일을 보내고 받기 위한 경제적이고 손쉬운 방법을 제공하는 이메일 플랫폼이다.</p>\n<h2>3. 사용자 인증 상태 변경 API 호출</h2>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/8c175da422bdda13c3eb36c437157b7f/7aaf2/email.jpg' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 72.35294117647058%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAOABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAECBAX/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAHpbYsYg//EABoQAAEFAQAAAAAAAAAAAAAAABABAgMREiH/2gAIAQEAAQUCR2Zx2x//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAYEAACAwAAAAAAAAAAAAAAAAABEQIQQf/aAAgBAQAGPwKTmEcd4r//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAQMUH/2gAIAQEAAT8hMzsuVrcwdf/aAAwDAQACAAMAAAAQZM//xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8QTJ//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAbEAEBAAIDAQAAAAAAAAAAAAABERAhAEGRUf/aAAgBAQABPxC15A1r0aIT3vOwo+Y328g6x//Z'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='전송된 이메일' title='전송된 이메일' src='/static/8c175da422bdda13c3eb36c437157b7f/a22ce/email.jpg' srcset='/static/8c175da422bdda13c3eb36c437157b7f/0b705/email.jpg 170w,\n/static/8c175da422bdda13c3eb36c437157b7f/31389/email.jpg 340w,\n/static/8c175da422bdda13c3eb36c437157b7f/a22ce/email.jpg 680w,\n/static/8c175da422bdda13c3eb36c437157b7f/7aaf2/email.jpg 776w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>전송된 이메일</figcaption>\n  </figure></p>\n<p>위처럼 이메일을 수신하면 사용자는 이메일 인증하기 버튼을 클릭해 인증하게 된다.<br>\n저 버튼의 href에는 백엔드 API의 endpoint가 정의된다.</p>\n<p>클릭해서 호출된 API는 사용자의 인증 상태를 변경해주는 API이다.<br>\n쿼리스트링으로 <code class=\"language-text\">token=&lt;JWT></code>을 받고,\n전달받은 JWT를 verify해서 확인을 하고 유효한 경우에만 다음으로 진행한다.</p>\n<p>JWT가 유효한 경우, 서비스 정책상 이메일 인증이 된 사용자만 로그인할 수 있도록 하고 있어서 이메일 인증 상태를 나타내는 필드를 true로 업데이트 해준다.</p>\n<p>그리고 24시간 내에 인증을 하지 못하면 유저 정보를 삭제하도록 하고 있기 때문에,<br>\n회원 가입 시 expiredAt을 24시간 이후로 설정하여 저장하고, (해당 필드는 ttl 설정 - mongoDB)\n이메일 인증이 되면 null로 변경해줘야 한다.</p>\n<h2>4. 리다이렉트</h2>\n<p>어떻게 해야하는건지 생각을 못했는데 아주 쉽게 해결된 부분이다.<br>\n사실 지금 생각해보니까 검색할 때 리다이렉트라고 검색해놓고 왜 response.redirect를 사용할 생각을 못했는지 의문...😅</p>\n<p>NestJS를 사용하고 있어 response 객체를 사용하진 않고 <code class=\"language-text\">@Redirect()</code>를 사용했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Redirect</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"리다이렉트 주소\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">async</span> <span class=\"token function\">emailAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Query</span></span><span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">)</span> token<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>authService<span class=\"token punctuation\">.</span><span class=\"token function\">updateVerifiedStatus</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> url<span class=\"token operator\">:</span> <span class=\"token string\">\"리다이렉트 주소\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// token 인증에 오류 발생하면 홈 화면으로 리다이렉트</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>에러 발생 시 <code class=\"language-text\">{url: \"리다이렉트 주소\"}</code>를 리턴하고 있는데,<br>\n이렇게 하면 위에 데코레이터에 사용한 주소가 아닌 새로 리턴한 주소로 리다이렉트 시킨다.<br>\n<a href=\"https://docs.nestjs.com/controllers#redirection\">공식 문서</a>를 참고하면 된다.</p>\n<h2>마무리</h2>\n<p>다행히 생각했던대로 만들어낼 수 있었던 것 같다.<br>\n다만 다른 곳에서는 유효시간을 두고 어떻게 인증하게 하는지는 조금 궁금함..<br>\n메일 전송 계속 다시 할 수 있게 하는지..</p>\n<p>AWS SES랑 redirect, forward는 다른 글에서 다시 한번 정리해보자~</p>","frontmatter":{"title":"NestJS와 AWS SES로 이메일 인증 구현하기","date":"June 28, 2023","update":"June 28, 2023","tags":["server","nodejs","NestJS","AWS"],"series":"NestJS 이메일 인증 구현 과정"},"fields":{"slug":"/230628-이메일 인증 구현.md/","readingTime":{"minutes":6.4}}},"seriesList":{"edges":[{"node":{"id":"0283c2c5-0197-58dd-919a-d4099f79c560","fields":{"slug":"/230627-이메일 인증 구현/"},"frontmatter":{"title":"회원가입, 비밀번호 찾기 이메일 인증 어떻게 하지?"}}},{"node":{"id":"acde1ad6-6b72-5651-aefe-bd777f19cc39","fields":{"slug":"/230628-이메일 인증 구현.md/"},"frontmatter":{"title":"NestJS와 AWS SES로 이메일 인증 구현하기"}}}]},"previous":{"fields":{"slug":"/230627-이메일 인증 구현/"},"frontmatter":{"title":"회원가입, 비밀번호 찾기 이메일 인증 어떻게 하지?"}},"next":{"fields":{"slug":"/230629.Set/"},"frontmatter":{"title":"Set (ES6)"}}},"pageContext":{"id":"acde1ad6-6b72-5651-aefe-bd777f19cc39","series":"NestJS 이메일 인증 구현 과정","previousPostId":"0283c2c5-0197-58dd-919a-d4099f79c560","nextPostId":"56584063-2d11-546f-84db-86f48c15caec"}},"staticQueryHashes":[]}